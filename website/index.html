<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APY over Epoch</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div>
        <label for="filterInput">Filter by Name:</label>
        <input type="text" id="filterInput" placeholder="Enter name" value="Blockdaemon">
    </div>
    <div style="max-width: 800px; margin: 0 auto;">
        <canvas id="apyChart" style="height: 400px;"></canvas>
    </div>
    <div style="max-width: 800px; margin: 0 auto;">
        <canvas id="gasPriceChart" style="height: 400px;"></canvas>
    </div>

    <script>
        async function fetchData() {
            try {
                const response = await fetch('https://api-sui.cryptosnapshotservice.com/api/data?network=mainnet');
                const data = await response.json();
                // Extract relevant data for the chart (APY over epoch)
                const apyData = data.map(item => ({
                    epoch: item.epoch,
                    apy: item.apy,
                    name: item.name,
                    gas_price: item.gas_price,
                    commission_rate: item.commission_rate

                }));
                return apyData;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        let myChart; // Declare the myChart variable in the global scope

        async function renderApyChart(filteredName = '') {
            const data = await fetchData();

            // Filter the data by name if provided
            const filteredData = filteredName ? data.filter(item => item.name.toLowerCase().includes(filteredName.toLowerCase())) : data;

            // Sort the data based on the epoch
            filteredData.sort((a, b) => a.epoch - b.epoch);

            // Extract the epochs and APY values for the chart
            const epochs = filteredData.map(item => item.epoch);
            const apyValues = filteredData.map(item => item.apy);

            // Destroy the previous chart instance (if any)
            if (myChart) {
                myChart.destroy();
            }

            // Create the chart using Chart.js
            const ctxApy = document.getElementById('apyChart').getContext('2d');
            const apyChart = new Chart(ctxApy, {
                type: 'line', // Use 'line' for a line chart
                data: {
                    labels: epochs,
                    datasets: [{
                        label: 'APY over Epoch',
                        data: apyValues,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: false // Don't fill the area under the line
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epoch'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'APY'
                            }
                        }
                    }
                }
            });
        }


        async function renderGasPriceChart(filteredName = '') {
            const data = await fetchData();

            // Filter the data by name if provided
            const filteredData = filteredName ? data.filter(item => item.name.toLowerCase().includes(filteredName.toLowerCase())) : data;

            // Sort the data based on the epoch
            filteredData.sort((a, b) => a.epoch - b.epoch);

            // Extract the epochs and gas price values for the chart
            const epochs = filteredData.map(item => item.epoch);
            const gasPrices = filteredData.map(item => item.gas_price);

            console.log(data)
            // Create the gas price chart using Chart.js
            const ctxGasPrice = document.getElementById('gasPriceChart').getContext('2d');
            const gasPriceChart = new Chart(ctxGasPrice, {
                type: 'line', // Use 'bar' for a bar chart
                data: {
                    labels: epochs,
                    datasets: [{
                        label: 'Gas Price by Epoch',
                        data: gasPrices,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epoch'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Gas Price'
                            }
                        }
                    }
                }
            });
        }


        // Add an event listener to the filter input
        document.getElementById('filterInput').addEventListener('input', function () {
            const nameFilter = this.value;
            renderApyChart(nameFilter);
            renderGasPriceChart(nameFilter);
        });

        // Initial rendering with the default filter value
        const defaultFilterValue = document.getElementById('filterInput').value;
        renderApyChart(defaultFilterValue);
        renderGasPriceChart(defaultFilterValue);
    </script>
</body>
</html>
