<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sui stats</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">

    <style>
        .chart-container {
            max-width: 50%;
            margin: 0 auto;
            float: left;
        }
        .filter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-container input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container mx-auto flex items-center">
        <label for="filterInput">Filter by Validator:</label>
        <div class="relative ml-4"> <!-- Adjust the width here -->
          <select id="nameSelect" class="block appearance-none bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline">
            <option value="">Select a Validator</option>
          </select>
        </div>

        <div class="relative ml-4"> <!-- Adjust the width here -->
          <select id="networkSelect" class="block appearance-none bg-white border border-gray-400 hover:border-gray-500 px-4 py-2 pr-8 rounded shadow leading-tight focus:outline-none focus:shadow-outline"> <!-- Adjust the width here -->
            <option value="mainnet">Mainnet</option>
            <option value="testnet">Testnet</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 13.293a1 1 0 0 1-1.414 0l-4-4a1 1 0 0 1 1.414-1.414L10 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0z"/></svg>
          </div>
        </div>

        <button id="downloadButton" class="ml-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Download CSV</button>
      </div>

    <div class="container mx-auto">
        <!-- First row of charts -->
        <div class="flex">
            <div class="chart-container w-1/2">
                <canvas id="apyChart" style="height: 500px;"></canvas>
            </div>
            <div class="chart-container w-1/2">
                <canvas id="gasPriceChart" style="height: 500px;"></canvas>
            </div>
        </div>
        <!-- Second row of charts -->
        <div class="flex">
            <div class="chart-container w-1/2">
                <canvas id="commisionRateChart" style="height: 500px;"></canvas>
            </div>
            <div class="chart-container w-1/2">
                <canvas id="stakeChart" style="height: 500px;"></canvas>
            </div>
        </div>
        <!-- Third row of charts -->
        <div class="flex">
            <div class="chart-container w-1/2">
                <canvas id="votePowerChart" style="height: 500px;"></canvas>
            </div>
            <table id="dataTable" class="display" style="width:50%;">
                <thead>
                    <tr>
                        <th>Epoch</th>
                        <th>APY</th>
                        <th>Name</th>
                        <th>Gas Price</th>
                        <th>Commission Rate</th>
                        <th>Voting Power</th>
                        <th>Stake</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data rows will be dynamically added here -->
                </tbody>
            </table>
        </div>

    </div>
    <script>
        // Function to trigger the CSV download
        function downloadCSV(url) {
            const link = document.createElement("a");
            link.href = url;
            link.target = "_blank";
            link.download = "data.csv";
            link.click();
        }
        // Function to handle button click event
        function handleDownloadClick() {
            const filterValue = document.getElementById("nameSelect").value;
            const networkValue = document.getElementById("networkSelect").value;
            const apiUrl = `https://api-sui.cryptosnapshotservice.com/api/csv?name=${encodeURIComponent(filterValue)}&network=${networkValue}`;

            fetch(apiUrl)
                .then(response => response.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    downloadCSV(url);
                })
                .catch(error => {
                    console.error("Error fetching CSV:", error);
                });
        }
        // Function to create the dropdown menu with names
        function createNameDropdown(names) {
            const nameSelect = document.getElementById("nameSelect");

            // Clear previous options from the select element
            nameSelect.innerHTML = "";

            // Add the default "Select a name" option as the first option
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "Select a name";
            nameSelect.appendChild(defaultOption);

            // Add options for each name
            names.forEach(name => {
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                nameSelect.appendChild(option);
            });
        }

        async function updateNameDrop() {
            try {
                const data = await fetchData();
                // Extract unique names from the data using a Set
                const uniqueNames = new Set(data.map(item => item.name));
                // Convert the Set back to an array
                const nameList = Array.from(uniqueNames);

                // Call the function to create the dropdown menu with names
                createNameDropdown(nameList);

                // Rest of your code to update the DataTable...

                // Set the default value after creating the dropdown
                const defaultName = "Blockdaemon"; // Replace this with your desired default name
                const nameSelect = document.getElementById("nameSelect");
                const defaultOptionElement = Array.from(nameSelect.options).find(option => option.value === defaultName);
                if (defaultOptionElement) {
                    nameSelect.selectedIndex = defaultOptionElement.index;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }


        async function fetchData() {
            try {
                const networkValue = document.getElementById("networkSelect").value;
                const response = await fetch(`https://api-sui.cryptosnapshotservice.com/api/data?network=${networkValue}`);
                const data = await response.json();
                // Extract relevant data for the chart (APY over epoch)
                const apyData = data.map(item => ({
                    epoch: item.epoch,
                    apy: item.apy,
                    name: item.name,
                    gas_price: item.gas_price,
                    commission_rate: item.commission_rate,
                    voting_power: item.voting_power,
                    stake: item.stake
                }));
                return apyData;
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        let apyChart;
        let votePowerChart;
        let stakeAmount;
        let commisionRateChart;
        let gasPriceChart;


        async function renderApyChart(filteredName = '') {
            const data = await fetchData();

            // Filter the data by name if provided
            const filteredData = filteredName ? data.filter(item => item.name.toLowerCase().includes(filteredName.toLowerCase())) : data;

            // Sort the data based on the epoch
            filteredData.sort((a, b) => a.epoch - b.epoch);

            // Extract the epochs and APY values for the chart
            const epochs = filteredData.map(item => item.epoch);
            const apyValues = filteredData.map(item => item.apy);

            // Destroy the previous chart instance (if any)
            if (apyChart) {
                apyChart.destroy();
            }

            // Create the chart using Chart.js
            const ctxApy = document.getElementById('apyChart').getContext('2d');
            apyChart = new Chart(ctxApy, {
                type: 'line', // Use 'line' for a line chart
                data: {
                    labels: epochs,
                    datasets: [{
                        label: 'APY over Epoch',
                        data: apyValues,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: false // Don't fill the area under the line
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epoch'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'APY'
                            }
                        }
                    }
                }
            });
        }


        async function renderGasPriceChart(filteredName = '') {
            const data = await fetchData();

            // Filter the data by name if provided
            const filteredData = filteredName ? data.filter(item => item.name.toLowerCase().includes(filteredName.toLowerCase())) : data;

            // Sort the data based on the epoch
            filteredData.sort((a, b) => a.epoch - b.epoch);

            // Extract the epochs and gas price values for the chart
            const epochs = filteredData.map(item => item.epoch);
            const gasPrices = filteredData.map(item => item.gas_price);

            // Destroy the previous chart instance (if any)
            if (gasPriceChart) {
                gasPriceChart.destroy();
            }
            // Create the gas price chart using Chart.js
            const ctxGasPrice = document.getElementById('gasPriceChart').getContext('2d');
            gasPriceChart = new Chart(ctxGasPrice, {
                type: 'line', // Use 'bar' for a bar chart
                data: {
                    labels: epochs,
                    datasets: [{
                        label: 'Gas Price by Epoch',
                        data: gasPrices,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epoch'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Gas Price'
                            }
                        }
                    }
                }
            });
        }

        async function renderCommisionRate(filteredName = '') {
            const data = await fetchData();

            // Filter the data by name if provided
            const filteredData = filteredName ? data.filter(item => item.name.toLowerCase().includes(filteredName.toLowerCase())) : data;

            // Sort the data based on the epoch
            filteredData.sort((a, b) => a.epoch - b.epoch);

            // Extract the epochs and gas price values for the chart
            const epochs = filteredData.map(item => item.epoch);
            const commisionRateCharts = filteredData.map(item => item.commission_rate / 100);

            // Destroy the previous chart instance (if any)
            if (commisionRateChart) {
                commisionRateChart.destroy();
            }
            // Create the gas price chart using Chart.js
            const ctxcommisionRateChart= document.getElementById('commisionRateChart').getContext('2d');
            commisionRateChart = new Chart(ctxcommisionRateChart, {
                type: 'line', // Use 'bar' for a bar chart
                data: {
                    labels: epochs,
                    datasets: [{
                        label: 'Commission rate by Epoch',
                        data: commisionRateCharts,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epoch'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Commision rate'
                            }
                        }
                    }
                }
            });
        }

        async function renderCommisionRate(filteredName = '') {
            const data = await fetchData();

            // Filter the data by name if provided
            const filteredData = filteredName ? data.filter(item => item.name.toLowerCase().includes(filteredName.toLowerCase())) : data;

            // Sort the data based on the epoch
            filteredData.sort((a, b) => a.epoch - b.epoch);

            // Extract the epochs and gas price values for the chart
            const epochs = filteredData.map(item => item.epoch);
            const commisionRateCharts = filteredData.map(item => item.commission_rate / 100);

            // Destroy the previous chart instance (if any)
            if (commisionRateChart) {
                commisionRateChart.destroy();
            }
            // Create the gas price chart using Chart.js
            const ctxcommisionRateChart= document.getElementById('commisionRateChart').getContext('2d');
            commisionRateChart = new Chart(ctxcommisionRateChart, {
                type: 'line', // Use 'bar' for a bar chart
                data: {
                    labels: epochs,
                    datasets: [{
                        label: 'Commusion rate by Epoch',
                        data: commisionRateCharts,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epoch'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Commision rate'
                            }
                        }
                    }
                }
            });
        }

        async function renderStake(filteredName = '') {
            const data = await fetchData();

            // Filter the data by name if provided
            const filteredData = filteredName ? data.filter(item => item.name.toLowerCase().includes(filteredName.toLowerCase())) : data;

            // Sort the data based on the epoch
            filteredData.sort((a, b) => a.epoch - b.epoch);

            // Extract the epochs and gas price values for the chart
            const epochs = filteredData.map(item => item.epoch);
            const stakeCharts = filteredData.map(item => item.stake / 1000000000);

            // Destroy the previous chart instance (if any)
           if (stakeAmount) {
                stakeAmount.destroy();
            }
            // Create the gas price chart using Chart.js
            const ctxstakeAmount= document.getElementById('stakeChart').getContext('2d');
            stakeAmount = new Chart(ctxstakeAmount, {
                type: 'line', // Use 'bar' for a bar chart
                data: {
                    labels: epochs,
                    datasets: [{
                        label: 'Stake by Epoch',
                        data: stakeCharts,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epoch'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Stake'
                            }
                        }
                    }
                }
            });
        }

        async function renderVotePower(filteredName = '') {
            const data = await fetchData();

            // Filter the data by name if provided
            const filteredData = filteredName ? data.filter(item => item.name.toLowerCase().includes(filteredName.toLowerCase())) : data;

            // Sort the data based on the epoch
            filteredData.sort((a, b) => a.epoch - b.epoch);

            // Extract the epochs and gas price values for the chart
            const epochs = filteredData.map(item => item.epoch);
            const votePowerCharts = filteredData.map(item => item.voting_power);

            // Destroy the previous chart instance (if any)
            if (votePowerChart) {
                votePowerChart.destroy();
            }

            // Create the gas price chart using Chart.js
            const ctxvotePowerChart= document.getElementById('votePowerChart').getContext('2d');
            votePowerChart = new Chart(ctxvotePowerChart, {
                type: 'line', // Use 'bar' for a bar chart
                data: {
                    labels: epochs,
                    datasets: [{
                        label: 'Vote Power by Epoch',
                        data: votePowerCharts,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Epoch'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Vote power'
                            }
                        }
                    }
                }
            });
        }

        async function updateTable(filteredName = '') {
            const data = await fetchData();
            const filteredData = filteredName ? data.filter(item => item.name.toLowerCase().includes(filteredName.toLowerCase())) : data;
            console.log(filteredData);

            // Convert the filteredData array of objects to an array of arrays
            const dataTableData = filteredData.map(item => [
                item.epoch,
                ((item.apy) * 100).toFixed(4) + "%",
                item.name,
                item.gas_price,
                item.commission_rate,
                item.voting_power,
                (item.stake / 1000000000).toLocaleString(undefined, { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }),
            ]);

            const dataTable = $('#dataTable').DataTable();
            dataTable.clear().rows.add(dataTableData).draw();
        }


        // Add an event listener to the filter input
        document.getElementById('nameSelect').addEventListener('input', function () {
            const nameFilter = this.value;
            renderApyChart(nameFilter);
            renderGasPriceChart(nameFilter);
            renderCommisionRate(nameFilter);
            renderStake(nameFilter);
            renderVotePower(nameFilter);
        });

        // Initial rendering with the default filter value
        updateNameDrop()
        const defaultFilterValue = 'Blockdaemon';
        renderApyChart(defaultFilterValue);
        renderGasPriceChart(defaultFilterValue);
        renderCommisionRate(defaultFilterValue);
        renderStake(defaultFilterValue);
        renderVotePower(defaultFilterValue);
        updateTable(defaultFilterValue);

        // Function to update the chart with new data
        async function updateChart() {
            const nameFilter = document.getElementById('nameSelect').value;
            renderApyChart(nameFilter);
            renderGasPriceChart(nameFilter);
            renderCommisionRate(nameFilter);
            renderStake(nameFilter);
            renderVotePower(nameFilter);
            updateTable(nameFilter);
        }

        const networkSelect = document.getElementById("networkSelect");
        networkSelect.addEventListener("change", () => {
            // Reload the page when the network selection changes
            updateChart();
        });

        const nameSelect = document.getElementById("nameSelect");
        nameSelect.addEventListener("change", () => {
            // Reload the page when the network selection changes
            updateChart();
        });
        // Attach click event to the download button
        const downloadButton = document.getElementById("downloadButton");
        downloadButton.addEventListener("click", handleDownloadClick);
    </script>
</body>
</html>
